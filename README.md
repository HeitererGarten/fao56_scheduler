# AquaCrop-based Irrigation Scheduler

![Python 3.12.9](https://img.shields.io/badge/python-3.12.9-blue.svg)

## Overview

This module is designed to assist with agricultural irrigation management using the AquaCrop model. It provides tools to:

* Fetch and process climate (weather) and soil data required for AquaCrop simulations.
* Optimize irrigation schedules based on soil moisture targets (SMT) to maximize crop yield, considering factors like maximum seasonal irrigation.
* Explore and visualize AquaCrop model outputs using a Jupyter Notebook.

## Key Features

* **Automated Data Preparation**:
  * Fetches weather data (leveraging concepts from NASA POWER API).
  * Fetches soil data using the Open-EPI Soil API.
  * Processes and formats this data into AquaCrop-compatible files.
* **Irrigation Optimization**:
  * Utilizes `scipy.optimize.fmin` to find optimal Soil Moisture Targets (SMTs) for irrigation.
  * Considers user-defined parameters like crop type, planting dates, soil characteristics, and maximum irrigation per season.
* **AquaCrop Simulation**:
  * Runs AquaCrop model simulations based on the prepared data and optimized (or custom) irrigation strategies.
* **Modular Design**:
  * Core logic is separated into scripts for data preparation (`profile_prep.py`) and schedule optimization (`scheduler.py`).
  * Helper modules for API interactions and data conversions are located in the `lib/` directory.
  * A Jupyter notebook (`prediction_model.ipynb`) provides an interactive environment for model exploration.

## Directory Structure

```text
iot_extra/
├── config.yaml                 # Main configuration (latitude, longitude, dates)
├── profile_prep.py             # Script to fetch and prepare weather and soil data
├── scheduler.py                # Script to optimize irrigation schedules
├── prediction_model.ipynb      # Jupyter Notebook for model exploration and visualization
├── README.md                   # This file
├── requirements.txt            # Python package dependencies (to be generated)
├── db/                         # Directory for data files
│   ├── climate_data.txt        # Processed climate data for AquaCrop
│   ├── soil_data.csv           # Processed soil data for AquaCrop
│   ├── raw_weather_df.csv      # Intermediate raw weather data (example)
│   └── optimized_irr_schedule.csv # Output from scheduler.py
│   └── irr_schedule.csv        # Example output from prediction_model.ipynb
└── lib/                        # Supporting library modules
    ├── soil_api_client.py      # Client for fetching soil data
    ├── weather_prep.py         # Utilities for weather data processing
    └── ...                     # Other utility scripts
```

## Basic Usage

1. **Configuration**:
   * Edit `iot_extra/config.yaml` to specify your target `lat` (latitude), `lon` (longitude), `start_date` (YYYYMMDD), and `end_date` (YYYYMMDD) for data fetching.

2. **Install Dependencies**:
   * Ensure you have Python 3.12.9 or compatible.
   * Install the required packages (once `requirements.txt` is generated):

     ```bash
     pip install -r path/to/iot_extra/requirements.txt
     ```

3. **Data Preparation**:
   * Run the `profile_prep.py` script to fetch and process climate and soil data. This will create/update files in the `iot_extra/db/` directory.

     ```bash
     python path/to/iot_extra/profile_prep.py
     ```

4. **Schedule Optimization**:
   * Run the `scheduler.py` script to calculate an optimized irrigation schedule based on the prepared data and default model parameters.

     ```bash
     python path/to/iot_extra/scheduler.py
     ```

   * The optimized schedule will be saved to `iot_extra/db/optimized_irr_schedule.csv`.

5. **Model Exploration and Prediction**:
   * Open and run the `iot_extra/prediction_model.ipynb` Jupyter Notebook to:
     * Visualize input data.
     * Run custom AquaCrop model simulations.
     * Analyze and plot model outputs (e.g., yield, water flux).

## Expected Inputs

* **`iot_extra/config.yaml`**:
  * `lat`: Latitude of the location (decimal degrees).
  * `lon`: Longitude of the location (decimal degrees).
  * `start_date`: Start date for data fetching and simulation (format: YYYYMMDD).
  * `end_date`: End date for data fetching and simulation (format: YYYYMMDD).
* The `scheduler.py` and `prediction_model.ipynb` expect `climate_data.txt` and `soil_data.csv` to be present in the `iot_extra/db/` directory, which are generated by `profile_prep.py`.

## Expected Outputs

* **`iot_extra/db/climate_data.txt`**: Formatted climate data ready for AquaCrop.
* **`iot_extra/db/soil_data.csv`**: Formatted soil profile data.
* **`iot_extra/db/raw_weather_df.csv`**: Raw weather data fetched before processing (generated by `profile_prep.py`).
* **`iot_extra/db/optimized_irr_schedule.csv`**: CSV file containing the optimized daily irrigation amounts (output of `scheduler.py`).
* **`iot_extra/db/irr_schedule.csv`**: An example irrigation schedule that can be generated from `prediction_model.ipynb`.

## Credits

This project utilizes the following open-source projects:

* [AquaCrop](https://github.com/aquacropos/aquacrop?tab=readme-ov-file)
* [aquacrop-eto](https://github.com/aquacropos/aquacrop-eto)
* [nasa-power-api](https://github.com/kdmayer/nasa-power-api): Portions of the weather data processing logic in `profile_prep.py` are adapted from this project by kdmayer.

## Requirements

* Python 3.12.9
* Required Python packages (see `requirements.txt`)
* Access to the internet for data fetching (weather and soil data APIs)
